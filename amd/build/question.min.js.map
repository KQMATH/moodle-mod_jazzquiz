{"version":3,"file":"question.min.js","sources":["../src/question.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {Quiz, Ajax, setText} from 'mod_jazzquiz/core';\nimport selectors from 'mod_jazzquiz/selectors';\n\n/**\n * Current question.\n *\n * @module    mod_jazzquiz\n * @author    Sebastian S. Gundersen <sebastian@sgundersen.com>\n * @copyright 2024 NTNU\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nexport class Question {\n\n    constructor(quiz) {\n        this.quiz = quiz;\n        this.isRunning = false;\n        this.isSaving = false;\n        this.endTime = 0;\n        this.isVoteRunning = false;\n        this.hasVotes = false;\n        this.countdownTimeLeft = 0;\n        this.questionTime = 0;\n        this.countdownInterval = 0;\n        this.timerInterval = 0;\n    }\n\n    static get box() {\n        return document.querySelector(selectors.question.box);\n    }\n\n    static get timer() {\n        return document.querySelector(selectors.question.timer);\n    }\n\n    static get form() {\n        return document.querySelector(selectors.question.form);\n    }\n\n    /**\n     * Request the current question form.\n     */\n    refresh() {\n        Ajax.get('get_question_form', {}, data => {\n            if (data.is_already_submitted) {\n                setText(Quiz.info, 'wait_for_instructor');\n                return;\n            }\n            Quiz.show(Question.box.html(data.html));\n            // eslint-disable-next-line no-eval\n            eval(data.js);\n            data.css.forEach(cssUrl => {\n                let head = document.getElementsByTagName('head')[0];\n                let style = document.createElement('link');\n                style.rel = 'stylesheet';\n                style.type = 'text/css';\n                style.href = cssUrl;\n                head.appendChild(style);\n            });\n            if (this.quiz.role.onQuestionRefreshed !== undefined) {\n                this.quiz.role.onQuestionRefreshed(data);\n            }\n            Quiz.renderAllMathjax();\n        });\n    }\n\n    /**\n     * Hide the question \"ending in\" timer, and clears the interval.\n     */\n    hideTimer() {\n        Quiz.hide(Question.timer);\n        clearInterval(this.timerInterval);\n        this.timerInterval = 0;\n    }\n\n    /**\n     * Is called for every second of the question countdown.\n     * @param {number} questionTime in seconds\n     */\n    onCountdownTick(questionTime) {\n        this.countdownTimeLeft--;\n        if (this.countdownTimeLeft <= 0) {\n            clearInterval(this.countdownInterval);\n            this.countdownInterval = 0;\n            this.startAttempt(questionTime);\n        } else if (this.countdownTimeLeft !== 0) {\n            setText(Quiz.info, 'question_will_start_in_x_seconds', 'jazzquiz', this.countdownTimeLeft);\n        } else {\n            setText(Quiz.info, 'question_will_start_now');\n        }\n    }\n\n    /**\n     * Start a countdown for the question which will eventually start the question attempt.\n     * The question attempt might start before this function return, depending on the arguments.\n     * If a countdown has already been started, this call will return true and the current countdown will continue.\n     * @param {number} questionTime\n     * @param {number} countdownTimeLeft\n     * @return {boolean} true if countdown is active\n     */\n    startCountdown(questionTime, countdownTimeLeft) {\n        if (this.countdownInterval !== 0) {\n            return true;\n        }\n        questionTime = parseInt(questionTime);\n        countdownTimeLeft = parseInt(countdownTimeLeft);\n        this.countdownTimeLeft = countdownTimeLeft;\n        if (countdownTimeLeft < 1) {\n            // Check if the question has already ended.\n            if (questionTime > 0 && countdownTimeLeft < -questionTime) {\n                return false;\n            }\n            // No need to start the countdown. Just start the question.\n            if (questionTime > 1) {\n                this.startAttempt(questionTime + countdownTimeLeft);\n            } else {\n                this.startAttempt(0);\n            }\n            return true;\n        }\n        this.countdownInterval = setInterval(() => this.onCountdownTick(questionTime), 1000);\n        return true;\n    }\n\n    /**\n     * When the question \"ending in\" timer reaches 0 seconds, this will be called.\n     */\n    onTimerEnding() {\n        this.isRunning = false;\n        if (this.quiz.role.onTimerEnding !== undefined) {\n            this.quiz.role.onTimerEnding();\n        }\n    }\n\n    /**\n     * Is called for every second of the \"ending in\" timer.\n     */\n    onTimerTick() {\n        const currentTime = new Date().getTime();\n        if (currentTime > this.endTime) {\n            this.hideTimer();\n            this.onTimerEnding();\n        } else {\n            const timeLeft = parseInt((this.endTime - currentTime) / 1000);\n            this.quiz.role.onTimerTick(timeLeft);\n        }\n    }\n\n    /**\n     * Request the current question from the server.\n     * @param {number} questionTime\n     */\n    startAttempt(questionTime) {\n        Quiz.hide(Quiz.info);\n        this.refresh();\n        // Set this to true so that we don't keep calling this over and over.\n        this.isRunning = true;\n        questionTime = parseInt(questionTime);\n        if (questionTime === 0) {\n            // 0 means no timer.\n            return;\n        }\n        this.quiz.role.onTimerTick(questionTime); // TODO: Is it worth having this line?\n        this.endTime = new Date().getTime() + questionTime * 1000;\n        this.timerInterval = setInterval(() => this.onTimerTick(), 1000);\n    }\n\n    static isLoaded() {\n        return Question.box.html() !== '';\n    }\n\n}\n"],"names":["Question","constructor","quiz","isRunning","isSaving","endTime","isVoteRunning","hasVotes","countdownTimeLeft","questionTime","countdownInterval","timerInterval","box","document","querySelector","selectors","question","timer","form","refresh","get","data","is_already_submitted","Quiz","info","show","html","eval","js","css","forEach","cssUrl","head","getElementsByTagName","style","createElement","rel","type","href","appendChild","undefined","this","role","onQuestionRefreshed","renderAllMathjax","hideTimer","hide","clearInterval","onCountdownTick","startAttempt","startCountdown","parseInt","setInterval","onTimerEnding","onTimerTick","currentTime","Date","getTime","timeLeft"],"mappings":";;;;;;;;0IA2BaA,SAETC,YAAYC,WACHA,KAAOA,UACPC,WAAY,OACZC,UAAW,OACXC,QAAU,OACVC,eAAgB,OAChBC,UAAW,OACXC,kBAAoB,OACpBC,aAAe,OACfC,kBAAoB,OACpBC,cAAgB,EAGdC,wBACAC,SAASC,cAAcC,mBAAUC,SAASJ,KAG1CK,0BACAJ,SAASC,cAAcC,mBAAUC,SAASC,OAG1CC,yBACAL,SAASC,cAAcC,mBAAUC,SAASE,MAMrDC,qBACSC,IAAI,oBAAqB,IAAIC,OAC1BA,KAAKC,uCACGC,WAAKC,KAAM,mCAGlBC,KAAKzB,SAASY,IAAIc,KAAKL,KAAKK,OAEjCC,KAAKN,KAAKO,IACVP,KAAKQ,IAAIC,SAAQC,aACTC,KAAOnB,SAASoB,qBAAqB,QAAQ,GAC7CC,MAAQrB,SAASsB,cAAc,QACnCD,MAAME,IAAM,aACZF,MAAMG,KAAO,WACbH,MAAMI,KAAOP,OACbC,KAAKO,YAAYL,eAEsBM,IAAvCC,KAAKvC,KAAKwC,KAAKC,0BACVzC,KAAKwC,KAAKC,oBAAoBtB,iBAElCuB,uBAObC,uBACSC,KAAK9C,SAASiB,OACnB8B,cAAcN,KAAK9B,oBACdA,cAAgB,EAOzBqC,gBAAgBvC,mBACPD,oBACDiC,KAAKjC,mBAAqB,GAC1BuC,cAAcN,KAAK/B,wBACdA,kBAAoB,OACpBuC,aAAaxC,eACgB,IAA3BgC,KAAKjC,oCACJe,WAAKC,KAAM,mCAAoC,WAAYiB,KAAKjC,qCAEhEe,WAAKC,KAAM,2BAY3B0B,eAAezC,aAAcD,0BACM,IAA3BiC,KAAK/B,oBAGTD,aAAe0C,SAAS1C,cACxBD,kBAAoB2C,SAAS3C,wBACxBA,kBAAoBA,kBACrBA,kBAAoB,IAEhBC,aAAe,GAAKD,mBAAqBC,gBAIzCA,aAAe,OACVwC,aAAaxC,aAAeD,wBAE5ByC,aAAa,IAEf,SAENvC,kBAAoB0C,aAAY,IAAMX,KAAKO,gBAAgBvC,eAAe,MACxE,IAMX4C,qBACSlD,WAAY,OACoBqC,IAAjCC,KAAKvC,KAAKwC,KAAKW,oBACVnD,KAAKwC,KAAKW,gBAOvBC,oBACUC,aAAc,IAAIC,MAAOC,aAC3BF,YAAcd,KAAKpC,aACdwC,iBACAQ,oBACF,OACGK,SAAWP,UAAUV,KAAKpC,QAAUkD,aAAe,UACpDrD,KAAKwC,KAAKY,YAAYI,WAQnCT,aAAaxC,yBACJqC,KAAKvB,WAAKC,WACVL,eAEAhB,WAAY,EAEI,KADrBM,aAAe0C,SAAS1C,sBAKnBP,KAAKwC,KAAKY,YAAY7C,mBACtBJ,SAAU,IAAImD,MAAOC,UAA2B,IAAfhD,kBACjCE,cAAgByC,aAAY,IAAMX,KAAKa,eAAe,8BAI5B,KAAxBtD,SAASY,IAAIc"}