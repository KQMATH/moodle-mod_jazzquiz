{"version":3,"file":"core.min.js","sources":["../src/core.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module    mod_jazzquiz\n * @author    Sebastian S. Gundersen <sebastian@sgundersen.com>\n * @copyright 2014 University of Wisconsin - Madison\n * @copyright 2018 NTNU\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport {get_string} from 'core/str';\nimport {notifyFilterContentUpdated} from 'core_filters/events';\nimport selectors from 'mod_jazzquiz/selectors';\nimport {Question} from 'mod_jazzquiz/question';\n\n// Contains the needed values for using the ajax script.\nlet session = {\n    courseModuleId: 0,\n    activityId: 0, // TODO: Remove activityId? Unsure if used.\n    sessionId: 0,\n    attemptId: 0,\n    sessionKey: ''\n};\n\n// Used for caching the latex of maxima input.\nlet cache = [];\n\n// TODO: Migrate to core/ajax module?\nexport class Ajax {\n\n    /**\n     * Send a request using AJAX, with method specified.\n     *\n     * @param {string} method Which HTTP method to use.\n     * @param {string} url Relative to root of jazzquiz module. Does not start with /.\n     * @param {Object} data Object with parameters as properties. Reserved: id, quizid, sessionid, attemptid, sesskey\n     * @param {function} success Callback function for when the request was completed successfully.\n     * @return {jqXHR} The jQuery XHR object\n     */\n    static request(method, url, data, success) {\n        data.id = session.courseModuleId;\n        data.sessionid = session.sessionId;\n        data.attemptid = session.attemptId;\n        data.sesskey = session.sessionKey;\n        return $.ajax({\n            type: method,\n            url: url,\n            data: data,\n            dataType: 'json',\n            success: success\n        }).fail(() => setText(document.querySelector(selectors.quiz.info), 'error_with_request'));\n    }\n\n    /**\n     * Send a GET request using AJAX.\n     * @param {string} action Which action to query.\n     * @param {Object} data Object with parameters as properties. Reserved: id, quizid, sessionid, attemptid, sesskey\n     * @param {function} success Callback function for when the request was completed successfully.\n     * @return {jqXHR} The jQuery XHR object\n     */\n    static get(action, data, success) {\n        data.action = action;\n        return Ajax.request('get', 'ajax.php', data, success);\n    }\n\n    /**\n     * Send a POST request using AJAX.\n     * @param {string} action Which action to query.\n     * @param {Object} data Object with parameters as properties. Reserved: id, quizid, sessionid, attemptid, sesskey\n     * @param {function} success Callback function for when the request was completed successfully.\n     * @return {jqXHR} The jQuery XHR object\n     */\n    static post(action, data, success) {\n        data.action = action;\n        return Ajax.request('post', 'ajax.php', data, success);\n    }\n\n}\n\nexport class Quiz {\n\n    constructor(Role) {\n        this.state = '';\n        this.isNewState = false;\n        this.question = new Question(this);\n        this.role = new Role(this);\n        this.events = {\n            notrunning: 'onNotRunning',\n            preparing: 'onPreparing',\n            running: 'onRunning',\n            reviewing: 'onReviewing',\n            sessionclosed: 'onSessionClosed',\n            voting: 'onVoting'\n        };\n    }\n\n    changeQuizState(state, data) {\n        this.isNewState = (this.state !== state);\n        this.state = state;\n        if (this.role.onStateChange !== undefined) {\n            this.role.onStateChange();\n        }\n        const event = this.events[state];\n        this.role[event](data);\n    }\n\n    /**\n     * Initiate the chained session info calls to ajax.php\n     * @param {number} ms interval in milliseconds\n     */\n    poll(ms) {\n        Ajax.get('info', {}, data => {\n            this.changeQuizState(data.status, data);\n            setTimeout(() => this.poll(ms), ms);\n        });\n    }\n\n    /**\n     * Triggers a dynamic content update event, which MathJax listens to.\n     */\n    static renderAllMathjax() {\n        notifyFilterContentUpdated(document.getElementsByClassName('jazzquiz-response-container'));\n    }\n\n    /**\n     * Sets the body of the target, and triggers an event letting MathJax know about the element.\n     * @param {*} target\n     * @param {string} latex\n     */\n    static addMathjaxElement(target, latex) {\n        target.innerHTML = '<span class=\"filter_mathjaxloader_equation\">' + latex + '</span>';\n        Quiz.renderAllMathjax();\n    }\n\n    /**\n     * Converts the input to LaTeX and renders it to the target with MathJax.\n     * @param {string} input\n     * @param {string} targetId\n     */\n    static renderMaximaEquation(input, targetId) {\n        const target = document.getElementById(targetId);\n        if (target === null) {\n            return;\n        }\n        if (cache[input] !== undefined) {\n            Quiz.addMathjaxElement(document.getElementById(targetId), cache[input]);\n            return;\n        }\n        Ajax.get('stack', {input: encodeURIComponent(input)}, data => {\n            cache[data.original] = data.latex;\n            Quiz.addMathjaxElement(document.getElementById(targetId), data.latex);\n        });\n    }\n\n}\n\n/**\n * Retrieve a language string that was sent along with the page.\n * @param {*} element\n * @param {string} key Which string in the language file we want.\n * @param {string} [from=jazzquiz] Which language file we want the string from. Default is jazzquiz.\n * @param {array} [args=[]] This is {$a} in the string for the key.\n */\nexport function setText(element, key, from, args) {\n    from = (from !== undefined) ? from : 'jazzquiz';\n    args = (args !== undefined) ? args : [];\n    $.when(get_string(key, from, args)).done(text => {\n        element.innerHTML = text;\n        element.classList.remove('hidden');\n    });\n}\n\n/**\n * Initialize session data.\n *\n * @param {number} courseModuleId\n * @param {number} activityId\n * @param {number} sessionId\n * @param {number} attemptId\n * @param {string} sessionKey\n */\nexport function initialize(courseModuleId, activityId, sessionId, attemptId, sessionKey) {\n    session.courseModuleId = courseModuleId;\n    session.activityId = activityId;\n    session.sessionId = sessionId;\n    session.attemptId = attemptId;\n    session.sessionKey = sessionKey;\n}\n"],"names":["courseModuleId","activityId","sessionId","attemptId","sessionKey","session","cache","Ajax","method","url","data","success","id","sessionid","attemptid","sesskey","$","ajax","type","dataType","fail","setText","document","querySelector","selectors","quiz","info","action","request","Quiz","constructor","Role","state","isNewState","question","Question","this","role","events","notrunning","preparing","running","reviewing","sessionclosed","voting","changeQuizState","undefined","onStateChange","event","poll","ms","get","status","setTimeout","getElementsByClassName","target","latex","innerHTML","renderAllMathjax","input","targetId","getElementById","encodeURIComponent","original","addMathjaxElement","element","key","from","args","when","done","text","classList","remove"],"mappings":";;;;;;;6HAmM2BA,eAAgBC,WAAYC,UAAWC,UAAWC,YACzEC,QAAQL,eAAiBA,eACzBK,QAAQJ,WAAaA,WACrBI,QAAQH,UAAYA,UACpBG,QAAQF,UAAYA,UACpBE,QAAQD,WAAaA,+HA1KrBC,QAAU,CACVL,eAAgB,EAChBC,WAAY,EACZC,UAAW,EACXC,UAAW,EACXC,WAAY,IAIZE,MAAQ,SAGCC,oBAWMC,OAAQC,IAAKC,KAAMC,gBAC9BD,KAAKE,GAAKP,QAAQL,eAClBU,KAAKG,UAAYR,QAAQH,UACzBQ,KAAKI,UAAYT,QAAQF,UACzBO,KAAKK,QAAUV,QAAQD,WAChBY,gBAAEC,KAAK,CACVC,KAAMV,OACNC,IAAKA,IACLC,KAAMA,KACNS,SAAU,OACVR,QAASA,UACVS,MAAK,IAAMC,QAAQC,SAASC,cAAcC,mBAAUC,KAAKC,MAAO,mCAU5DC,OAAQjB,KAAMC,gBACrBD,KAAKiB,OAASA,OACPpB,KAAKqB,QAAQ,MAAO,WAAYlB,KAAMC,qBAUrCgB,OAAQjB,KAAMC,gBACtBD,KAAKiB,OAASA,OACPpB,KAAKqB,QAAQ,OAAQ,WAAYlB,KAAMC,mCAKzCkB,KAETC,YAAYC,WACHC,MAAQ,QACRC,YAAa,OACbC,SAAW,IAAIC,mBAASC,WACxBC,KAAO,IAAIN,KAAKK,WAChBE,OAAS,CACVC,WAAY,eACZC,UAAW,cACXC,QAAS,YACTC,UAAW,cACXC,cAAe,kBACfC,OAAQ,YAIhBC,gBAAgBb,MAAOtB,WACduB,WAAcG,KAAKJ,QAAUA,WAC7BA,MAAQA,WACmBc,IAA5BV,KAAKC,KAAKU,oBACLV,KAAKU,sBAERC,MAAQZ,KAAKE,OAAON,YACrBK,KAAKW,OAAOtC,MAOrBuC,KAAKC,IACD3C,KAAK4C,IAAI,OAAQ,IAAIzC,YACZmC,gBAAgBnC,KAAK0C,OAAQ1C,MAClC2C,YAAW,IAAMjB,KAAKa,KAAKC,KAAKA,wEAQT5B,SAASgC,uBAAuB,yDAQtCC,OAAQC,OAC7BD,OAAOE,UAAY,+CAAiDD,MAAQ,UAC5E3B,KAAK6B,+CAQmBC,MAAOC,UAEhB,OADAtC,SAASuC,eAAeD,iBAIlBd,IAAjBxC,MAAMqD,OAIVpD,KAAK4C,IAAI,QAAS,CAACQ,MAAOG,mBAAmBH,SAASjD,OAClDJ,MAAMI,KAAKqD,UAAYrD,KAAK8C,MAC5B3B,KAAKmC,kBAAkB1C,SAASuC,eAAeD,UAAWlD,KAAK8C,UAL/D3B,KAAKmC,kBAAkB1C,SAASuC,eAAeD,UAAWtD,MAAMqD,mBAkB5DtC,QAAQ4C,QAASC,IAAKC,KAAMC,MACxCD,UAAiBrB,IAATqB,KAAsBA,KAAO,WACrCC,UAAiBtB,IAATsB,KAAsBA,KAAO,mBACnCC,MAAK,mBAAWH,IAAKC,KAAMC,OAAOE,MAAKC,OACrCN,QAAQR,UAAYc,KACpBN,QAAQO,UAAUC,OAAO"}