define("mod_jazzquiz/instructor",["exports","jquery","mod_jazzquiz/core","mod_jazzquiz/question","mod_jazzquiz/selectors"],(function(_exports,_jquery,_core,_question,_selectors){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * @module    mod_jazzquiz
   * @author    Sebastian S. Gundersen <sebastian@sgundersen.com>
   * @copyright 2014 University of Wisconsin - Madison
   * @copyright 2018 NTNU
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initialize=void 0,_jquery=_interopRequireDefault(_jquery),_selectors=_interopRequireDefault(_selectors);class ResponseView{constructor(quiz){this.quiz=quiz,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,document.addEventListener("click",(event=>{event.target.closest(_selectors.default.quiz.undoMergeButton)&&this.undoMerge();event.target.closest(_selectors.default.quiz.showNormalResultsButton)&&this.refresh(!1);event.target.closest(_selectors.default.quiz.showVoteResultsButton)&&this.refreshVotes(),event.target.classList.contains("bar")?this.startMerge(event.target.id):event.target.parentNode&&event.target.parentNode.classList.contains("bar")&&this.startMerge(event.target.parentNode.id)}))}clear(){document.querySelector(_selectors.default.quiz.responses).innerHTML="",document.querySelector(_selectors.default.quiz.responseInfo).innerHTML=""}hide(){Instructor.control("responses").querySelector(".fa").classList.replace("fa-check-square-o","fa-square-o"),document.querySelector(_selectors.default.quiz.responses).classList.add("hidden"),document.querySelector(_selectors.default.quiz.responseInfo).classList.add("hidden")}show(){Instructor.control("responses").querySelector(".fa").classList.replace("fa-square-o","fa-check-square-o"),document.querySelector(_selectors.default.quiz.responses).classList.remove("hidden"),document.querySelector(_selectors.default.quiz.responseInfo).classList.remove("hidden"),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}toggle(){this.showResponses=!this.showResponses,this.showResponses?this.show():this.hide()}endMerge(){document.querySelectorAll(_selectors.default.quiz.mergeInto).forEach((element=>element.classList.remove("merge-into"))),document.querySelectorAll(_selectors.default.quiz.mergeFrom).forEach((element=>element.classList.remove("merge-from")))}undoMerge(){_core.Ajax.post("undo_merge",{},(()=>this.refresh(!0)))}merge(from,into){_core.Ajax.post("merge_responses",{from:from,into:into},(()=>this.refresh(!1)))}startMerge(fromRowBarId){const barCell=document.getElementById(fromRowBarId),row=barCell.parentElement;if(row.classList.contains("merge-from"))this.endMerge();else{if(row.classList.contains("merge-into")){const fromRow=document.querySelector(_selectors.default.quiz.mergeFrom);return this.merge(fromRow.dataset.response,row.dataset.response),void this.endMerge()}row.classList.add("merge-from"),row.closest("table").querySelectorAll("tr").forEach((tableRow=>{const cell=tableRow.querySelector("td:nth-child(2)");cell&&cell.id!==barCell.id&&tableRow.classList.add("merge-into")}))}}createControls(name){const quizResponseInfo=document.querySelector(_selectors.default.quiz.responseInfo);if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){let showNormalResult=document.querySelector(_selectors.default.quiz.showNormalResultsButton),showVoteResult=document.querySelector(_selectors.default.quiz.showVoteResultsButton);quizResponseInfo.classList.remove("hidden"),"vote_response"===name?showNormalResult||((0,_core.setText)(quizResponseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),quizResponseInfo.innerHTML+='<button id="review_show_normal_results" class="btn btn-primary"></button><br>',showNormalResult=document.querySelector(_selectors.default.quiz.showNormalResultsButton),(0,_core.setText)(showNormalResult,"click_to_show_original_results"),showVoteResult.remove()):"current_response"===name&&(showVoteResult||(quizResponseInfo.innerHTML='<h4 class="inline"></h4>',(0,_core.setText)(quizResponseInfo.querySelector("h4"),"showing_original_results"),quizResponseInfo.innerHTML+='<button id="review_show_vote_results" class="btn btn-primary"></button><br>',showVoteResult=document.querySelector(_selectors.default.quiz.showVoteResultsButton),(0,_core.setText)(showVoteResult,"click_to_show_vote_results"),showNormalResult.remove()))}}else quizResponseInfo.classList.add("hidden")}addBarGraphRow(target,name,response,i,highestResponseCount){const percent=parseInt(response.count)/highestResponseCount*100;let rowIndex=-1,currentRowIndex=-1;for(let j=0;j<target.rows.length;j++)if(target.rows[j].dataset.response===response.response){rowIndex=parseInt(target.rows[j].dataset.rowIndex),currentRowIndex=j;break}if(-1===rowIndex){rowIndex=target.rows.length;let row=target.insertRow();row.dataset.responseIndex=i,row.dataset.response=response.response,row.dataset.percent=percent,row.dataset.rowIndex=rowIndex,row.dataset.count=response.count,row.classList.add("selected-vote-option"),percent<15&&row.classList.add("outside");const countHtml='<span id="'+name+"_count_"+rowIndex+'">'+response.count+"</span>";let responseCell=row.insertCell(0);responseCell.onclick=()=>responseCell.parentElement.classList.toggle("selected-vote-option");let barCell=row.insertCell(1);barCell.classList.add("bar"),barCell.id=name+"_bar_"+rowIndex,barCell.innerHTML='<div style="width:'+percent+'%;">'+countHtml+"</div>";const latexId=name+"_latex_"+rowIndex;responseCell.innerHTML='<span id="'+latexId+'"></span>',_core.Quiz.addMathjaxElement(document.getElementById(latexId),response.response),"stack"===response.qtype&&_core.Quiz.renderMaximaEquation(response.response,latexId)}else{let currentRow=target.rows[currentRowIndex];currentRow.dataset.rowIndex=rowIndex,currentRow.dataset.responseIndex=i,currentRow.dataset.percent=percent,currentRow.dataset.count=response.count;const containsOutside=currentRow.classList.contains("outside");percent>15&&containsOutside?currentRow.classList.remove("outside"):percent<15&&!containsOutside&&currentRow.classList.add("outside");let countElement=document.getElementById(name+"_count_"+rowIndex);null!==countElement&&(countElement.innerHTML=response.count);let barElement=document.getElementById(name+"_bar_"+rowIndex);null!==barElement&&(barElement.firstElementChild.style.width=percent+"%")}}createBarGraph(responses,name,targetId,graphId,rebuild){let target=document.getElementById(targetId);if(null===target)return;let highestResponseCount=0;for(let i=0;i<responses.length;i++){let count=parseInt(responses[i].count);count>highestResponseCount&&(highestResponseCount=count)}rebuild&&(target.innerHTML="");for(let i=0;i<target.rows.length;i++){let prune=!0;for(let j=0;j<responses.length;j++)if(target.rows[i].dataset.response===responses[j].response){prune=!1;break}prune&&(target.deleteRow(i),i--)}this.createControls(name),name+=graphId;for(let i=0;i<responses.length;i++)this.addBarGraphRow(target,name,responses[i],i,highestResponseCount)}static sortBarGraph(targetId){let target=document.getElementById(targetId);if(null===target)return;let isSorting=!0;for(;isSorting;){isSorting=!1;for(let i=0;i<target.rows.length-1;i++){if(parseInt(target.rows[i].dataset.percent)<parseInt(target.rows[i+1].dataset.percent)){target.rows[i].parentNode.insertBefore(target.rows[i+1],target.rows[i]),isSorting=!0;break}}}}set(wrapperId,tableId,responses,responded,questionType,graphId,rebuild){if(void 0===responses)return;const quizResponded=document.querySelector(_selectors.default.quiz.responded);if(0===responses.length)return quizResponded.classList.remove("hidden"),void(0,_core.setText)(quizResponded.querySelector("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(questionType){case"shortanswer":for(let i=0;i<responses.length;i++)responses[i].response=responses[i].response.trim();break;case"stack":for(let i=0;i<responses.length;i++)responses[i].response=responses[i].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(let i=0;i<responses.length;i++){let exists=!1,count=1;void 0!==responses[i].count&&(count=parseInt(responses[i].count)),this.respondedCount+=count;for(let j=0;j<this.currentResponses.length;j++)if(this.currentResponses[j].response===responses[i].response){this.currentResponses[j].count+=count,exists=!0;break}exists||this.currentResponses.push({response:responses[i].response,count:count,qtype:questionType})}if(0!==quizResponded.length&&void 0!==responded&&(quizResponded.classList.remove("hidden"),(0,_core.setText)(quizResponded.querySelector("h4"),"a_out_of_b_responded","jazzquiz",{a:responded,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return document.querySelector(_selectors.default.quiz.responseInfo).classList.add("hidden"),void document.querySelector(_selectors.default.quiz.responses).classList.add("hidden");if(null===document.getElementById(tableId)){const wrapper=document.getElementById(wrapperId);wrapper.innerHTML='<table id="'.concat(tableId,'" class="jazzquiz-responses-overview"></table>'),wrapper.classList.remove("hidden")}this.createBarGraph(this.currentResponses,"current_response",tableId,graphId,rebuild),ResponseView.sortBarGraph(tableId)}refresh(rebuild){_core.Ajax.get("get_results",{},(data=>{this.quiz.question.hasVotes=data.has_votes,this.totalStudents=parseInt(data.total_students),this.set("jazzquiz_responses_container","current_responses_wrapper",data.responses,data.responded,data.question_type,"results",rebuild);const undoMergeButton=document.querySelector(_selectors.default.quiz.undoMergeButton);undoMergeButton&&undoMergeButton.classList.toggle("hidden",data.merge_count<=0)}))}refreshVotes(){const quizResponses=document.querySelector(_selectors.default.quiz.responses),quizResponseInfo=document.querySelector(_selectors.default.quiz.responseInfo);if(!this.showResponses&&"reviewing"!==this.quiz.state)return quizResponseInfo.classList.add("hidden"),void quizResponses.classList.add("hidden");_core.Ajax.get("get_vote_results",{},(data=>{const answers=data.answers,targetId="wrapper_vote_responses";let responses=[];this.respondedCount=0,this.totalStudents=parseInt(data.total_students);for(let i in answers)answers.hasOwnProperty(i)&&(responses.push({response:answers[i].attempt,count:answers[i].finalcount,qtype:answers[i].qtype,slot:answers[i].slot}),this.respondedCount+=parseInt(answers[i].finalcount));(0,_core.setText)(document.querySelector(_selectors.default.quiz.responded+" h4"),"a_out_of_b_voted","jazzquiz",{a:this.respondedCount,b:this.totalStudents}),null===document.getElementById(targetId)&&(quizResponses.innerHTML='<table id="'.concat(targetId,'" class="jazzquiz-responses-overview"></table>'),quizResponses.classList.remove("hidden")),this.createBarGraph(responses,"vote_response",targetId,"vote",!1),ResponseView.sortBarGraph(targetId)}))}}class Instructor{constructor(quiz){this.quiz=quiz,this.responses=new ResponseView(quiz),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,this.allowVote=!1,document.addEventListener("keyup",(event=>{"Escape"===event.key&&Instructor.closeFullscreenView()})),Instructor.addEvents({repoll:()=>this.repollQuestion(),vote:()=>this.runVoting(),improvise:()=>this.showQuestionListSetup("improvise"),jump:()=>this.showQuestionListSetup("jump"),next:()=>this.nextQuestion(),random:()=>this.randomQuestion(),end:()=>this.endQuestion(),fullscreen:()=>Instructor.showFullscreenView(),answer:()=>this.showCorrectAnswer(),responses:()=>this.responses.toggle(),exit:()=>this.closeSession(),quit:()=>this.closeSession(),startquiz:()=>this.startQuiz()}),Instructor.addHotkeys({t:"responses",r:"repoll",a:"answer",e:"end",j:"jump",i:"improvise",v:"vote",n:"next",m:"random",f:"fullscreen"}),document.addEventListener("click",(event=>{Instructor.closeQuestionListMenu(event,"improvise"),Instructor.closeQuestionListMenu(event,"jump"),event.target.closest(_selectors.default.quiz.startQuizButton)&&this.startQuiz(),event.target.closest(_selectors.default.quiz.exitQuizButton)&&this.closeSession()}))}static addHotkeys(keys){for(let key in keys)keys.hasOwnProperty(key)&&(keys[key]={action:keys[key],repeat:!1},document.addEventListener("keydown",(event=>{if(keys[key].repeat||event.ctrlKey)return;if(event.key.toLowerCase()!==key)return;let focusedTag=(0,_jquery.default)(":focus").prop("tagName");if(void 0!==focusedTag&&(focusedTag=focusedTag.toLowerCase(),"input"===focusedTag||"textarea"===focusedTag))return;event.preventDefault(),keys[key].repeat=!0;let $control=Instructor.control(keys[key].action);$control.length&&!$control.prop("disabled")&&$control.click()})),document.addEventListener("keyup",(event=>{event.key.toLowerCase()===key&&(keys[key].repeat=!1)})))}static addEvents(events){document.addEventListener("click",(event=>{const controlButton=event.target.closest(_selectors.default.quiz.controlButton);controlButton&&(Instructor.enableControls([]),events[controlButton.dataset.control]())}))}static get controls(){return document.querySelector(_selectors.default.quiz.controlsBox)}static get controlButtons(){return document.querySelector(_selectors.default.quiz.controlButtons)}static control(key){return document.getElementById("jazzquiz_control_".concat(key))}static get side(){return document.querySelector(_selectors.default.quiz.sideContainer)}static get correctAnswer(){return document.querySelector(_selectors.default.quiz.correctAnswerContainer)}static get isMerging(){return 0!==(0,_jquery.default)(".merge-from").length}onNotRunning(data){this.responses.totalStudents=data.student_count,Instructor.side.classList.add("hidden"),(0,_core.setText)(document.querySelector(_selectors.default.quiz.info),"instructions_for_instructor"),Instructor.enableControls([]),document.querySelector(_selectors.default.quiz.controlButtons).classList.add("hidden");const studentsJoined=document.querySelector(_selectors.default.quiz.studentsJoinedCounter);1===data.student_count?(0,_core.setText)(studentsJoined,"one_student_has_joined"):data.student_count>1?(0,_core.setText)(studentsJoined,"x_students_have_joined","jazzquiz",data.student_count):(0,_core.setText)(studentsJoined,"no_students_have_joined");Instructor.control("startquiz").parentElement.classList.remove("hidden")}onPreparing(data){Instructor.side.classList.add("hidden"),(0,_core.setText)(document.querySelector(_selectors.default.quiz.info),"instructions_for_instructor");let enabledButtons=["improvise","jump","random","fullscreen","quit"];data.slot<this.totalQuestions&&enabledButtons.push("next"),Instructor.enableControls(enabledButtons)}onRunning(data){if(this.responses.showResponses||this.responses.hide(),Instructor.side.classList.remove("hidden"),Instructor.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=data.questiontime,this.quiz.question.isRunning)data.questionTime>0&&data.delay<-data.questiontime&&this.endQuestion(),this.responses.refresh(!Instructor.isMerging);else{this.quiz.question.startCountdown(data.questiontime,data.delay)&&(this.quiz.question.isRunning=!0)}}onReviewing(data){Instructor.side.classList.remove("hidden");let enabledButtons=["answer","repoll","fullscreen","improvise","jump","random","quit"];this.allowVote&&enabledButtons.push("vote"),data.slot<this.totalQuestions&&enabledButtons.push("next"),Instructor.enableControls(enabledButtons),_question.Question.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}onSessionClosed(){Instructor.side.classList.add("hidden"),Instructor.correctAnswer.classList.add("hidden"),Instructor.enableControls([]),this.responses.clear(),this.quiz.question.isRunning=!1}onVoting(){this.responses.showResponses||this.responses.hide(),Instructor.side.classList.remove("hidden"),Instructor.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}onStateChange(){Instructor.controlButtons.classList.remove("hidden"),Instructor.control("startquiz").parentElement.classList.add("hidden")}onQuestionRefreshed(data){this.allowVote=data.voteable}onTimerEnding(){this.endQuestion()}onTimerTick(timeLeft){(0,_core.setText)(document.querySelector(_selectors.default.question.timer),"x_seconds_left","jazzquiz",timeLeft)}startQuiz(){Instructor.control("startquiz").parentElement.classList.add("hidden"),_core.Ajax.post("start_quiz",{},(()=>{const controls=document.querySelector(_selectors.default.quiz.controls);controls&&controls.classList.remove("btn-hide")}))}endQuestion(){this.quiz.question.hideTimer(),_core.Ajax.post("end_question",{},(()=>{"voting"===this.quiz.state?this.responses.showVotesUponReview=!0:(this.quiz.question.isRunning=!1,Instructor.enableControls([]))}))}showQuestionListSetup(name){let controlButton=Instructor.control(name);controlButton.classList.contains("active")||_core.Ajax.get("list_".concat(name,"_questions"),{},(data=>{controlButton.classList.add("active");const menu=document.querySelector("#jazzquiz_".concat(name,"_menu"));menu.innerHTML="",menu.classList.add("active");const margin=controlButton.getBoundingClientRect().left-controlButton.parentElement.getBoundingClientRect().left;menu.style.marginLeft=margin+"px";const questions=data.questions;for(let i in questions){if(!questions.hasOwnProperty(i))continue;let questionButton=document.createElement("BUTTON");questionButton.classList.add("btn"),_core.Quiz.addMathjaxElement(questionButton,questions[i].name),questionButton.dataset.time=questions[i].time,questionButton.dataset.questionId=questions[i].questionid,questionButton.dataset.jazzquizQuestionId=questions[i].jazzquizquestionid,questionButton.addEventListener("click",(()=>{const questionId=questionButton.dataset.questionId,time=questionButton.dataset.time,jazzQuestionId=questionButton.dataset.jazzquizQuestionId;this.jumpQuestion(questionId,time,jazzQuestionId),menu.innerHTML="",menu.classList.remove("active"),controlButton.classList.remove("active")})),menu.appendChild(questionButton)}}))}static getSelectedAnswersForVote(){return document.querySelectorAll(_selectors.default.quiz.selectedVoteOption).map((option=>({text:option.dataset.response,count:option.dataset.count})))}runVoting(){const options=Instructor.getSelectedAnswersForVote(),data={questions:encodeURIComponent(JSON.stringify(options))};_core.Ajax.post("run_voting",data)}startQuestion(method,questionId,questionTime,jazzquizQuestionId){document.querySelector(_selectors.default.quiz.info).classList.add("hidden"),this.responses.clear(),this.hideCorrectAnswer(),_core.Ajax.post("start_question",{method:method,questionid:questionId,questiontime:questionTime,jazzquizquestionid:jazzquizQuestionId},(data=>this.quiz.question.startCountdown(data.questiontime,data.delay)))}jumpQuestion(questionId,questionTime,jazzquizQuestionId){this.startQuestion("jump",questionId,questionTime,jazzquizQuestionId)}repollQuestion(){this.startQuestion("repoll",0,0,0)}nextQuestion(){this.startQuestion("next",0,0,0)}randomQuestion(){this.startQuestion("random",0,0,0)}closeSession(){document.querySelector(_selectors.default.quiz.undoMergeButton).classList.add("hidden"),document.querySelector(_selectors.default.question.box).classList.add("hidden"),Instructor.controls.classList.add("hidden"),(0,_core.setText)(document.querySelector(_selectors.default.quiz.info),"closing_session"),_core.Ajax.post("close_session",{},(()=>window.location=location.href.split("&")[0]))}hideCorrectAnswer(){this.isShowingCorrectAnswer&&(Instructor.correctAnswer.classList.add("hidden"),Instructor.control("answer").querySelector(".fa").classList.replace("fa-check-square-o","fa-square-o"),this.isShowingCorrectAnswer=!1)}showCorrectAnswer(){this.hideCorrectAnswer(),_core.Ajax.get("get_right_response",{},(data=>{Instructor.correctAnswer.innerHTML=data.right_answer,Instructor.correctAnswer.classList.remove("hidden"),_core.Quiz.renderAllMathjax(),Instructor.control("answer").querySelector(".fa").classList.replace("fa-square-o","fa-check-square-o"),this.isShowingCorrectAnswer=!0}))}static enableControls(buttons){document.querySelectorAll(_selectors.default.quiz.controlButton).forEach((controlButton=>{controlButton.disabled=-1===buttons.indexOf(controlButton.dataset.control)}))}static showFullscreenView(){document.querySelector(_selectors.default.main).classList.contains("jazzquiz-fullscreen")?Instructor.closeFullscreenView():(document.documentElement.style.overflowY="hidden",document.querySelector(_selectors.default.main).classList.add("jazzquiz-fullscreen"))}static closeFullscreenView(){document.documentElement.style.overflowY="auto",document.querySelector(_selectors.default.main).classList.remove("jazzquiz-fullscreen")}static closeQuestionListMenu(event,name){if(!event.target.closest("#jazzquiz_".concat(name,"_menu"))){const menu=document.querySelector("#jazzquiz_".concat(name,"_menu"));menu.innerHTML="",menu.classList.remove("active");const controlButton=document.querySelector("#jazzquiz_control_".concat(name));controlButton&&controlButton.classList.remove("active")}}static addReportEventHandlers(){document.addEventListener("click",(event=>{const reportOverviewControlsButton=event.target.closest("#report_overview_controls button");if(reportOverviewControlsButton){const action=reportOverviewControlsButton.dataset.action;"attendance"===action?(document.querySelector(_selectors.default.quiz.reportOverviewResponded).classList.remove("hidden"),document.querySelector(_selectors.default.quiz.reportOverviewResponses).classList.add("hidden")):"responses"===action&&(document.querySelector(_selectors.default.quiz.reportOverviewResponses).classList.remove("hidden"),document.querySelector(_selectors.default.quiz.reportOverviewResponded).classList.add("hidden"))}}))}}_exports.initialize=(totalQuestions,reportView,slots)=>{const quiz=new _core.Quiz(Instructor);quiz.role.totalQuestions=totalQuestions,reportView?(Instructor.addReportEventHandlers(),quiz.role.responses.showResponses=!0,slots.forEach((slot=>{const wrapper="jazzquiz_wrapper_responses_"+slot.num,table="responses_wrapper_table_"+slot.num,graph="report_"+slot.num;quiz.role.responses.set(wrapper,table,slot.responses,void 0,slot.type,graph,!1)}))):quiz.poll(500)}}));

//# sourceMappingURL=instructor.min.js.map