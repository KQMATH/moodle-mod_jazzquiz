{"version":3,"file":"instructor.min.js","sources":["../src/instructor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module    mod_jazzquiz\n * @author    Sebastian S. Gundersen <sebastian@sgundersen.com>\n * @copyright 2014 University of Wisconsin - Madison\n * @copyright 2018 NTNU\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport {Quiz, setText} from 'mod_jazzquiz/core';\nimport {Question} from 'mod_jazzquiz/question';\nimport selectors from 'mod_jazzquiz/selectors';\nimport {addMathjaxElement, renderMaximaEquation, renderAllMathjax} from 'mod_jazzquiz/math_rendering';\n\nclass ResponseView {\n    /**\n     * @param {Quiz} quiz\n     */\n    constructor(quiz) {\n        this.quiz = quiz;\n        this.currentResponses = [];\n        this.showVotesUponReview = false;\n        this.respondedCount = 0;\n        this.showResponses = false;\n        this.totalStudents = 0;\n\n        document.addEventListener('click', event => {\n            const undoMergeButton = event.target.closest(selectors.quiz.undoMergeButton);\n            if (undoMergeButton) {\n                this.undoMerge();\n            }\n\n            const showNormalResultsButton = event.target.closest(selectors.quiz.showNormalResultsButton);\n            if (showNormalResultsButton) {\n                this.refresh(false);\n            }\n\n            const showVoteResultsButton = event.target.closest(selectors.quiz.showVoteResultsButton);\n            if (showVoteResultsButton) {\n                this.refreshVotes();\n            }\n\n            // Clicking a row to merge.\n            if (event.target.classList.contains('bar')) {\n                this.startMerge(event.target.id);\n            } else if (event.target.parentNode && event.target.parentNode.classList.contains('bar')) {\n                this.startMerge(event.target.parentNode.id);\n            }\n        });\n    }\n\n    /**\n     * Clear, but not hide responses.\n     */\n    clear() {\n        document.querySelector(selectors.quiz.responses).innerHTML = '';\n        document.querySelector(selectors.quiz.responseInfo).innerHTML = '';\n    }\n\n    /**\n     * Hides the responses\n     */\n    hide() {\n        const responsesControl = document.getElementById(`jazzquiz_control_responses`);\n        if (responsesControl instanceof HTMLElement) {\n            const icon = responsesControl.querySelector('.fa');\n            if (icon instanceof HTMLElement) {\n                icon.classList.replace('fa-check-square-o', 'fa-square-o');\n            }\n        }\n        document.querySelector(selectors.quiz.responses).classList.add('hidden');\n        document.querySelector(selectors.quiz.responseInfo).classList.add('hidden');\n    }\n\n    /**\n     * Shows the responses\n     */\n    show() {\n        const responsesControl = document.getElementById(`jazzquiz_control_responses`);\n        if (responsesControl instanceof HTMLElement) {\n            const icon = responsesControl.querySelector('.fa');\n            if (icon instanceof HTMLElement) {\n                icon.classList.replace('fa-square-o', 'fa-check-square-o');\n            }\n        }\n        document.querySelector(selectors.quiz.responses).classList.remove('hidden');\n        document.querySelector(selectors.quiz.responseInfo).classList.remove('hidden');\n        if (this.showVotesUponReview) {\n            this.refreshVotes();\n            this.showVotesUponReview = false;\n        } else {\n            this.refresh(false);\n        }\n    }\n\n    /**\n     * Toggle whether to show or hide the responses\n     */\n    toggle() {\n        this.showResponses = !this.showResponses;\n        if (this.showResponses) {\n            this.show();\n        } else {\n            this.hide();\n        }\n    }\n\n    /**\n     * End the response merge.\n     */\n    endMerge() {\n        document.querySelectorAll(selectors.quiz.mergeInto).forEach(element => element.classList.remove('merge-into'));\n        document.querySelectorAll(selectors.quiz.mergeFrom).forEach(element => element.classList.remove('merge-from'));\n    }\n\n    /**\n     * Undo the last response merge.\n     */\n    undoMerge() {\n        Ajax.post('undo_merge', {}, () => this.refresh(true));\n    }\n\n    /**\n     * Merges responses based on response string.\n     * @param {string} from\n     * @param {string} into\n     */\n    merge(from, into) {\n        Ajax.post('merge_responses', {from: from, into: into}, () => this.refresh(false));\n    }\n\n    /**\n     * Start a merge between two responses.\n     * @param {string} fromRowBarId\n     */\n    startMerge(fromRowBarId) {\n        const barCell = document.getElementById(fromRowBarId);\n        const row = barCell.parentElement;\n        if (row.classList.contains('merge-from')) {\n            this.endMerge();\n            return;\n        }\n        if (row.classList.contains('merge-into')) {\n            const fromRow = document.querySelector(selectors.quiz.mergeFrom);\n            this.merge(fromRow.dataset.response, row.dataset.response);\n            this.endMerge();\n            return;\n        }\n        row.classList.add('merge-from');\n        row.closest('table').querySelectorAll('tr').forEach(tableRow => {\n            const cell = tableRow.querySelector('td:nth-child(2)');\n            if (cell && cell.id !== barCell.id) {\n                tableRow.classList.add('merge-into');\n            }\n        });\n    }\n\n    /**\n     * Create controls to toggle between the responses of the actual question and the vote that followed.\n     * @param {string} name Can be either 'vote_response' or 'current_response'\n     */\n    createControls(name) {\n        const quizResponseInfo = document.querySelector(selectors.quiz.responseInfo);\n        if (!this.quiz.question.hasVotes) {\n            quizResponseInfo.classList.add('hidden');\n            return;\n        }\n        // Add button for instructor to change what to review.\n        if (this.quiz.state === 'reviewing') {\n            let showNormalResult = document.querySelector(selectors.quiz.showNormalResultsButton);\n            let showVoteResult = document.querySelector(selectors.quiz.showVoteResultsButton);\n            quizResponseInfo.classList.remove('hidden');\n            if (name === 'vote_response') {\n                if (!showNormalResult) {\n                    setText(quizResponseInfo.html('<h4 class=\"inline\"></h4>').children('h4'), 'showing_vote_results');\n                    quizResponseInfo.innerHTML += '<button id=\"review_show_normal_results\" class=\"btn btn-primary\"></button><br>';\n                    showNormalResult = document.querySelector(selectors.quiz.showNormalResultsButton);\n                    setText(showNormalResult, 'click_to_show_original_results');\n                    showVoteResult.remove();\n                }\n            } else if (name === 'current_response') {\n                if (!showVoteResult) {\n                    quizResponseInfo.innerHTML = '<h4 class=\"inline\"></h4>';\n                    setText(quizResponseInfo.querySelector('h4'), 'showing_original_results');\n                    quizResponseInfo.innerHTML += '<button id=\"review_show_vote_results\" class=\"btn btn-primary\"></button><br>';\n                    showVoteResult = document.querySelector(selectors.quiz.showVoteResultsButton);\n                    setText(showVoteResult, 'click_to_show_vote_results');\n                    showNormalResult.remove();\n                }\n            }\n        }\n    }\n\n    addBarGraphRow(target, name, response, i, highestResponseCount) {\n        // Const percent = (parseInt(responses[i].count) / total) * 100;\n        const percent = (parseInt(response.count) / highestResponseCount) * 100;\n\n        // Check if row with same response already exists.\n        let rowIndex = -1;\n        let currentRowIndex = -1;\n        for (let j = 0; j < target.rows.length; j++) {\n            if (target.rows[j].dataset.response === response.response) {\n                rowIndex = parseInt(target.rows[j].dataset.rowIndex);\n                currentRowIndex = j;\n                break;\n            }\n        }\n\n        if (rowIndex === -1) {\n            rowIndex = target.rows.length;\n            let row = target.insertRow();\n            row.dataset.responseIndex = i;\n            row.dataset.response = response.response;\n            row.dataset.percent = percent;\n            row.dataset.rowIndex = rowIndex;\n            row.dataset.count = response.count;\n            row.classList.add('selected-vote-option');\n            if (percent < 15) {\n                row.classList.add('outside');\n            }\n\n            const countHtml = '<span id=\"' + name + '_count_' + rowIndex + '\">' + response.count + '</span>';\n            let responseCell = row.insertCell(0);\n            responseCell.onclick = () => responseCell.parentElement.classList.toggle('selected-vote-option');\n\n            let barCell = row.insertCell(1);\n            barCell.classList.add('bar');\n            barCell.id = name + '_bar_' + rowIndex;\n            barCell.innerHTML = '<div style=\"width:' + percent + '%;\">' + countHtml + '</div>';\n\n            const latexId = name + '_latex_' + rowIndex;\n            responseCell.innerHTML = '<span id=\"' + latexId + '\"></span>';\n            addMathjaxElement(document.getElementById(latexId), response.response);\n            if (response.qtype === 'stack') {\n                renderMaximaEquation(response.response, latexId);\n            }\n        } else {\n            let currentRow = target.rows[currentRowIndex];\n            currentRow.dataset.rowIndex = rowIndex;\n            currentRow.dataset.responseIndex = i;\n            currentRow.dataset.percent = percent;\n            currentRow.dataset.count = response.count;\n            const containsOutside = currentRow.classList.contains('outside');\n            if (percent > 15 && containsOutside) {\n                currentRow.classList.remove('outside');\n            } else if (percent < 15 && !containsOutside) {\n                currentRow.classList.add('outside');\n            }\n            let countElement = document.getElementById(name + '_count_' + rowIndex);\n            if (countElement !== null) {\n                countElement.innerHTML = response.count;\n            }\n            let barElement = document.getElementById(name + '_bar_' + rowIndex);\n            if (barElement !== null) {\n                barElement.firstElementChild.style.width = percent + '%';\n            }\n        }\n    }\n\n    /**\n     * Create a new and unsorted response bar graph.\n     *\n     * @param {Array.<Object>} responses\n     * @param {string} name\n     * @param {string} targetId\n     * @param {string} graphId\n     * @param {boolean} rebuild If the table should be completely rebuilt or not\n     */\n    createBarGraph(responses, name, targetId, graphId, rebuild) {\n        let target = document.getElementById(targetId);\n        if (target === null) {\n            return;\n        }\n        let highestResponseCount = 0;\n        for (let i = 0; i < responses.length; i++) {\n            let count = parseInt(responses[i].count); // In case count is a string.\n            if (count > highestResponseCount) {\n                highestResponseCount = count;\n            }\n        }\n\n        // Remove the rows if it should be rebuilt.\n        if (rebuild) {\n            target.innerHTML = '';\n        }\n\n        // Prune rows.\n        for (let i = 0; i < target.rows.length; i++) {\n            let prune = true;\n            for (let j = 0; j < responses.length; j++) {\n                if (target.rows[i].dataset.response === responses[j].response) {\n                    prune = false;\n                    break;\n                }\n            }\n            if (prune) {\n                target.deleteRow(i);\n                i--;\n            }\n        }\n\n        // Add rows.\n        this.createControls(name);\n        name += graphId;\n        for (let i = 0; i < responses.length; i++) {\n            this.addBarGraphRow(target, name, responses[i], i, highestResponseCount);\n        }\n    }\n\n    /**\n     * Sort the responses in the graph by how many had the same response.\n     * @param {string} targetId\n     */\n    static sortBarGraph(targetId) {\n        let target = document.getElementById(targetId);\n        if (target === null) {\n            return;\n        }\n        let isSorting = true;\n        while (isSorting) {\n            isSorting = false;\n            for (let i = 0; i < (target.rows.length - 1); i++) {\n                const current = parseInt(target.rows[i].dataset.percent);\n                const next = parseInt(target.rows[i + 1].dataset.percent);\n                if (current < next) {\n                    target.rows[i].parentNode.insertBefore(target.rows[i + 1], target.rows[i]);\n                    isSorting = true;\n                    break;\n                }\n            }\n        }\n    }\n\n    /**\n     * Create and sort a bar graph based on the responses passed.\n     * @param {string} wrapperId\n     * @param {string} tableId\n     * @param {Array.<Object>} responses\n     * @param {number|undefined} responded How many students responded to the question\n     * @param {string} questionType\n     * @param {string} graphId\n     * @param {boolean} rebuild If the graph should be rebuilt or not.\n     */\n    set(wrapperId, tableId, responses, responded, questionType, graphId, rebuild) {\n        if (responses === undefined) {\n            return;\n        }\n        const quizResponded = document.querySelector(selectors.quiz.responded);\n\n        // Check if any responses to show.\n        if (responses.length === 0) {\n            quizResponded.classList.remove('hidden');\n            setText(quizResponded.querySelector('h4'), 'a_out_of_b_responded', 'jazzquiz', {\n                a: 0,\n                b: this.totalStudents\n            });\n            return;\n        }\n\n        // Question type specific.\n        switch (questionType) {\n            case 'shortanswer':\n                for (let i = 0; i < responses.length; i++) {\n                    responses[i].response = responses[i].response.trim();\n                }\n                break;\n            case 'stack':\n                // Remove all spaces from responses.\n                for (let i = 0; i < responses.length; i++) {\n                    responses[i].response = responses[i].response.replace(/\\s/g, '');\n                }\n                break;\n            default:\n                break;\n        }\n\n        // Update data.\n        this.currentResponses = [];\n        this.respondedCount = 0;\n        for (let i = 0; i < responses.length; i++) {\n            let exists = false;\n            let count = 1;\n            if (responses[i].count !== undefined) {\n                count = parseInt(responses[i].count);\n            }\n            this.respondedCount += count;\n            // Check if response is a duplicate.\n            for (let j = 0; j < this.currentResponses.length; j++) {\n                if (this.currentResponses[j].response === responses[i].response) {\n                    this.currentResponses[j].count += count;\n                    exists = true;\n                    break;\n                }\n            }\n            // Add element if not a duplicate.\n            if (!exists) {\n                this.currentResponses.push({\n                    response: responses[i].response,\n                    count: count,\n                    qtype: questionType\n                });\n            }\n        }\n\n        // Update responded container.\n        if (quizResponded.length !== 0 && responded !== undefined) {\n            quizResponded.classList.remove('hidden');\n            setText(quizResponded.querySelector('h4'), 'a_out_of_b_responded', 'jazzquiz', {\n                a: responded,\n                b: this.totalStudents\n            });\n        }\n\n        // Should we show the responses?\n        if (!this.showResponses && this.quiz.state !== 'reviewing') {\n            document.querySelector(selectors.quiz.responseInfo).classList.add('hidden');\n            document.querySelector(selectors.quiz.responses).classList.add('hidden');\n            return;\n        }\n\n        if (document.getElementById(tableId) === null) {\n            const wrapper = document.getElementById(wrapperId);\n            wrapper.innerHTML = `<table id=\"${tableId}\" class=\"jazzquiz-responses-overview\"></table>`;\n            wrapper.classList.remove('hidden');\n        }\n        this.createBarGraph(this.currentResponses, 'current_response', tableId, graphId, rebuild);\n        ResponseView.sortBarGraph(tableId);\n    }\n\n    /**\n     * Fetch and show results for the ongoing or previous question.\n     * @param {boolean} rebuild If the response graph should be rebuilt or not.\n     */\n    refresh(rebuild) {\n        Ajax.get('get_results', {}, data => {\n            this.quiz.question.hasVotes = data.has_votes;\n            this.totalStudents = parseInt(data.total_students);\n\n            this.set('jazzquiz_responses_container', 'current_responses_wrapper',\n                data.responses, data.responded, data.question_type, 'results', rebuild);\n\n            const undoMergeButton = document.querySelector(selectors.quiz.undoMergeButton);\n            if (undoMergeButton) {\n                undoMergeButton.classList.toggle('hidden', data.merge_count <= 0);\n            }\n        });\n    }\n\n    /**\n     * Method refresh() equivalent for votes.\n     */\n    refreshVotes() {\n        const quizResponses = document.querySelector(selectors.quiz.responses);\n        const quizResponseInfo = document.querySelector(selectors.quiz.responseInfo);\n        // Should we show the results?\n        if (!this.showResponses && this.quiz.state !== 'reviewing') {\n            quizResponseInfo.classList.add('hidden');\n            quizResponses.classList.add('hidden');\n            return;\n        }\n        Ajax.get('get_vote_results', {}, data => {\n            const answers = data.answers;\n            const targetId = 'wrapper_vote_responses';\n            let responses = [];\n            this.respondedCount = 0;\n            this.totalStudents = parseInt(data.total_students);\n            for (let i in answers) {\n                if (!answers.hasOwnProperty(i)) {\n                    continue;\n                }\n                responses.push({\n                    response: answers[i].attempt,\n                    count: answers[i].finalcount,\n                    qtype: answers[i].qtype,\n                    slot: answers[i].slot\n                });\n                this.respondedCount += parseInt(answers[i].finalcount);\n            }\n            setText(document.querySelector(selectors.quiz.responded + ' h4'), 'a_out_of_b_voted', 'jazzquiz', {\n                a: this.respondedCount,\n                b: this.totalStudents\n            });\n            if (document.getElementById(targetId) === null) {\n                quizResponses.innerHTML = `<table id=\"${targetId}\" class=\"jazzquiz-responses-overview\"></table>`;\n                quizResponses.classList.remove('hidden');\n            }\n            this.createBarGraph(responses, 'vote_response', targetId, 'vote', false);\n            ResponseView.sortBarGraph(targetId);\n        });\n    }\n\n}\n\nclass Instructor {\n\n    /**\n     * @param {Quiz} quiz\n     */\n    constructor(quiz) {\n        this.quiz = quiz;\n        this.responses = new ResponseView(quiz);\n        this.isShowingCorrectAnswer = false;\n        this.totalQuestions = 0;\n        this.allowVote = false;\n\n        document.addEventListener('keyup', event => {\n            if (event.key === 'Escape') {\n                Instructor.closeFullscreenView();\n            }\n        });\n\n        Instructor.addEvents({\n            'repoll': () => this.repollQuestion(),\n            'vote': () => this.runVoting(),\n            'improvise': () => this.showQuestionListSetup('improvise'),\n            'jump': () => this.showQuestionListSetup('jump'),\n            'next': () => this.nextQuestion(),\n            'random': () => this.randomQuestion(),\n            'end': () => this.endQuestion(),\n            'fullscreen': () => Instructor.showFullscreenView(),\n            'answer': () => this.showCorrectAnswer(),\n            'responses': () => this.responses.toggle(),\n            'exit': () => this.closeSession(),\n            'quit': () => this.closeSession(),\n            'startquiz': () => this.startQuiz()\n        });\n\n        Instructor.addHotkeys({\n            't': 'responses',\n            'r': 'repoll',\n            'a': 'answer',\n            'e': 'end',\n            'j': 'jump',\n            'i': 'improvise',\n            'v': 'vote',\n            'n': 'next',\n            'm': 'random',\n            'f': 'fullscreen'\n        });\n\n        document.addEventListener('click', event => {\n            Instructor.closeQuestionListMenu(event, 'improvise');\n            Instructor.closeQuestionListMenu(event, 'jump');\n            if (event.target.closest(selectors.quiz.startQuizButton)) {\n                this.startQuiz();\n            }\n            if (event.target.closest(selectors.quiz.exitQuizButton)) {\n                this.closeSession();\n            }\n        });\n    }\n\n    static addHotkeys(keys) {\n        for (let key in keys) {\n            if (keys.hasOwnProperty(key)) {\n                keys[key] = {\n                    action: keys[key],\n                    repeat: false // TODO: Maybe event.repeat becomes more standard?\n                };\n\n                document.addEventListener('keydown', event => {\n                    if (keys[key].repeat || event.ctrlKey) {\n                        return;\n                    }\n                    if (event.key.toLowerCase() !== key) {\n                        return;\n                    }\n                    const focusedElement = document.querySelector(':focus');\n                    if (!(focusedElement instanceof HTMLElement)) {\n                        return;\n                    }\n                    const focusedTag = focusedElement.tagName.toLowerCase();\n                    if (focusedTag === 'input' || focusedTag === 'textarea') {\n                        return;\n                    }\n                    event.preventDefault();\n                    keys[key].repeat = true;\n                    const control = document.getElementById(`jazzquiz_control_${keys[key].action}`);\n                    if (control && !control.disabled) {\n                        control.click();\n                    }\n                });\n\n                document.addEventListener('keyup', event => {\n                    if (event.key.toLowerCase() === key) {\n                        keys[key].repeat = false;\n                    }\n                });\n            }\n        }\n    }\n\n    static addEvents(events) {\n        document.addEventListener('click', event => {\n            const controlButton = event.target.closest(selectors.quiz.controlButton);\n            if (controlButton) {\n                Instructor.enableControls([]);\n                events[controlButton.dataset.control]();\n            }\n        });\n    }\n\n    static control(key) {\n        return document.getElementById(`jazzquiz_control_${key}`);\n    }\n\n    static get side() {\n        return document.querySelector(selectors.quiz.sideContainer);\n    }\n\n    onNotRunning(data) {\n        this.responses.totalStudents = data.student_count;\n        Instructor.side.classList.add('hidden');\n        setText(document.querySelector(selectors.quiz.info), 'instructions_for_instructor');\n        Instructor.enableControls([]);\n        document.querySelector(selectors.quiz.controlButtons).classList.add('hidden');\n        const studentsJoined = document.querySelector(selectors.quiz.studentsJoinedCounter);\n        if (data.student_count === 1) {\n            setText(studentsJoined, 'one_student_has_joined');\n        } else if (data.student_count > 1) {\n            setText(studentsJoined, 'x_students_have_joined', 'jazzquiz', data.student_count);\n        } else {\n            setText(studentsJoined, 'no_students_have_joined');\n        }\n        const startQuizButton = document.getElementById(`jazzquiz_control_startquiz`);\n        if (startQuizButton) {\n            startQuizButton.parentElement.classList.remove('hidden');\n        }\n    }\n\n    onPreparing(data) {\n        Instructor.side.classList.add('hidden');\n        setText(document.querySelector(selectors.quiz.info), 'instructions_for_instructor');\n        let enabledButtons = ['improvise', 'jump', 'random', 'fullscreen', 'quit'];\n        if (data.slot < this.totalQuestions) {\n            enabledButtons.push('next');\n        }\n        Instructor.enableControls(enabledButtons);\n    }\n\n    onRunning(data) {\n        if (!this.responses.showResponses) {\n            this.responses.hide();\n        }\n        Instructor.side.classList.remove('hidden');\n        Instructor.enableControls(['end', 'responses', 'fullscreen']);\n        this.quiz.question.questionTime = data.questiontime;\n        if (this.quiz.question.isRunning) {\n            // Check if the question has already ended.\n            // We need to do this because the state does not update unless an instructor is connected.\n            if (data.questionTime > 0 && data.delay < -data.questiontime) {\n                this.endQuestion();\n            }\n            // Only rebuild results if we are not merging.\n            const mergeFrom = document.querySelector('.merge-from');\n            this.responses.refresh(mergeFrom === null);\n        } else {\n            const started = this.quiz.question.startCountdown(data.questiontime, data.delay);\n            if (started) {\n                this.quiz.question.isRunning = true;\n            }\n        }\n    }\n\n    onReviewing(data) {\n        Instructor.side.classList.remove('hidden');\n        let enabledButtons = ['answer', 'repoll', 'fullscreen', 'improvise', 'jump', 'random', 'quit'];\n        if (this.allowVote) {\n            enabledButtons.push('vote');\n        }\n        if (data.slot < this.totalQuestions) {\n            enabledButtons.push('next');\n        }\n        Instructor.enableControls(enabledButtons);\n\n        // In case page was refreshed, we should ensure the question is showing.\n        if (!Question.isLoaded()) {\n            this.quiz.question.refresh();\n        }\n\n        // For now, just always show responses while reviewing.\n        // In the future, there should be an additional toggle.\n        if (this.quiz.isNewState) {\n            this.responses.show();\n        }\n        // No longer in question.\n        this.quiz.question.isRunning = false;\n    }\n\n    onSessionClosed() {\n        Instructor.side.classList.add('hidden');\n        const correctAnswer = document.querySelector(selectors.quiz.correctAnswerContainer);\n        if (correctAnswer) {\n            correctAnswer.classList.add('hidden');\n        }\n        Instructor.enableControls([]);\n        this.responses.clear();\n        this.quiz.question.isRunning = false;\n    }\n\n    onVoting() {\n        if (!this.responses.showResponses) {\n            this.responses.hide();\n        }\n        Instructor.side.classList.remove('hidden');\n        Instructor.enableControls(['quit', 'fullscreen', 'answer', 'responses', 'end']);\n        this.responses.refreshVotes();\n    }\n\n    onStateChange() {\n        const controlButtons = document.querySelector(selectors.quiz.controlButtons);\n        if (controlButtons instanceof HTMLElement) {\n            controlButtons.classList.remove('hidden');\n        }\n        const startQuizControl = document.getElementById(`jazzquiz_control_startquiz`);\n        if (startQuizControl instanceof HTMLElement) {\n            startQuizControl.parentElement.classList.add('hidden');\n        }\n    }\n\n    onQuestionRefreshed(data) {\n        this.allowVote = data.voteable;\n    }\n\n    onTimerEnding() {\n        this.endQuestion();\n    }\n\n    onTimerTick(timeLeft) {\n        setText(document.querySelector(selectors.question.timer), 'x_seconds_left', 'jazzquiz', timeLeft);\n    }\n\n    /**\n     * Start the quiz. Does not start any questions.\n     */\n    startQuiz() {\n        const startQuizControl = document.getElementById(`jazzquiz_control_startquiz`);\n        if (startQuizControl instanceof HTMLElement) {\n            startQuizControl.parentElement.classList.add('hidden');\n        }\n        Ajax.post('start_quiz', {}, () => {\n            const controls = document.querySelector(selectors.quiz.controls);\n            if (controls) {\n                controls.classList.remove('btn-hide');\n            }\n        });\n    }\n\n    /**\n     * End the currently ongoing question or vote.\n     */\n    endQuestion() {\n        this.quiz.question.hideTimer();\n        Ajax.post('end_question', {}, () => {\n            if (this.quiz.state === 'voting') {\n                this.responses.showVotesUponReview = true;\n            } else {\n                this.quiz.question.isRunning = false;\n                Instructor.enableControls([]);\n            }\n        });\n    }\n\n    /**\n     * Show a question list dropdown.\n     * @param {string} name\n     */\n    showQuestionListSetup(name) {\n        const controlButton = document.getElementById(`jazzquiz_control_${name}`);\n        if (!controlButton) {\n            return;\n        }\n        if (controlButton.classList.contains('active')) {\n            // It's already open. Let's not send another request.\n            return;\n        }\n        Ajax.get(`list_${name}_questions`, {}, data => {\n            controlButton.classList.add('active');\n            const menu = document.querySelector(`#jazzquiz_${name}_menu`);\n            menu.innerHTML = '';\n            menu.classList.add('active');\n            const margin = controlButton.getBoundingClientRect().left - controlButton.parentElement.getBoundingClientRect().left;\n            menu.style.marginLeft = margin + 'px';\n            const questions = data.questions;\n            for (let i in questions) {\n                if (!questions.hasOwnProperty(i)) {\n                    continue;\n                }\n                let questionButton = document.createElement('BUTTON');\n                questionButton.classList.add('btn');\n                addMathjaxElement(questionButton, questions[i].name);\n                questionButton.dataset.time = questions[i].time;\n                questionButton.dataset.questionId = questions[i].questionid;\n                questionButton.dataset.jazzquizQuestionId = questions[i].jazzquizquestionid;\n                questionButton.addEventListener('click', () => {\n                    const questionId = questionButton.dataset.questionId;\n                    const time = questionButton.dataset.time;\n                    const jazzQuestionId = questionButton.dataset.jazzquizQuestionId;\n                    this.jumpQuestion(questionId, time, jazzQuestionId);\n                    menu.innerHTML = '';\n                    menu.classList.remove('active');\n                    controlButton.classList.remove('active');\n                });\n                menu.appendChild(questionButton);\n            }\n        });\n    }\n\n    /**\n     * Get the selected responses.\n     * @returns {Array.<Object>} Vote options\n     */\n    static getSelectedAnswersForVote() {\n        return document.querySelectorAll(selectors.quiz.selectedVoteOption).map(option => {\n            return {text: option.dataset.response, count: option.dataset.count};\n        });\n    }\n\n    /**\n     * Start a vote with the responses that are currently selected.\n     */\n    runVoting() {\n        const options = Instructor.getSelectedAnswersForVote();\n        const data = {questions: encodeURIComponent(JSON.stringify(options))};\n        Ajax.post('run_voting', data);\n    }\n\n    /**\n     * Start a new question in this session.\n     * @param {string} method\n     * @param {number} questionId\n     * @param {number} questionTime\n     * @param {number} jazzquizQuestionId\n     */\n    startQuestion(method, questionId, questionTime, jazzquizQuestionId) {\n        document.querySelector(selectors.quiz.info).classList.add('hidden');\n        this.responses.clear();\n        this.hideCorrectAnswer();\n        Ajax.post('start_question', {\n            method: method,\n            questionid: questionId,\n            questiontime: questionTime,\n            jazzquizquestionid: jazzquizQuestionId\n        }, data => this.quiz.question.startCountdown(data.questiontime, data.delay));\n    }\n\n    /**\n     * Jump to a planned question in the quiz.\n     * @param {number} questionId\n     * @param {number} questionTime\n     * @param {number} jazzquizQuestionId\n     */\n    jumpQuestion(questionId, questionTime, jazzquizQuestionId) {\n        this.startQuestion('jump', questionId, questionTime, jazzquizQuestionId);\n    }\n\n    /**\n     * Repoll the previously asked question.\n     */\n    repollQuestion() {\n        this.startQuestion('repoll', 0, 0, 0);\n    }\n\n    /**\n     * Continue on to the next preplanned question.\n     */\n    nextQuestion() {\n        this.startQuestion('next', 0, 0, 0);\n    }\n\n    /**\n     * Start a random question.\n     */\n    randomQuestion() {\n        this.startQuestion('random', 0, 0, 0);\n    }\n\n    /**\n     * Close the current session.\n     */\n    closeSession() {\n        document.querySelector(selectors.quiz.undoMergeButton).classList.add('hidden');\n        document.querySelector(selectors.question.box).classList.add('hidden');\n        const controls = document.querySelector(selectors.quiz.controlsBox);\n        if (controls) {\n            controls.classList.add('hidden');\n        }\n        setText(document.querySelector(selectors.quiz.info), 'closing_session');\n        Ajax.post('close_session', {}, () => {\n            window.location = location.href.split('&')[0];\n        });\n    }\n\n    /**\n     * Hide the correct answer if showing.\n     */\n    hideCorrectAnswer() {\n        if (this.isShowingCorrectAnswer) {\n            const correctAnswer = document.querySelector(selectors.quiz.correctAnswerContainer);\n            if (correctAnswer instanceof HTMLElement) {\n                correctAnswer.classList.add('hidden');\n            }\n            const answerControl = document.getElementById(`jazzquiz_control_answer`);\n            if (answerControl instanceof HTMLElement) {\n                const icon = answerControl.querySelector('.fa');\n                if (icon instanceof HTMLElement) {\n                    icon.classList.replace('fa-check-square-o', 'fa-square-o');\n                }\n            }\n            this.isShowingCorrectAnswer = false;\n        }\n    }\n\n    /**\n     * Request and show the correct answer for the ongoing or previous question.\n     */\n    showCorrectAnswer() {\n        this.hideCorrectAnswer();\n        Ajax.get('get_right_response', {}, data => {\n            const correctAnswer = document.querySelector(selectors.quiz.correctAnswerContainer);\n            if (correctAnswer instanceof HTMLElement) {\n                correctAnswer.innerHTML = data.right_answer;\n                correctAnswer.classList.remove('hidden');\n            }\n            renderAllMathjax();\n            const answerControl = document.getElementById(`jazzquiz_control_answer`);\n            if (answerControl instanceof HTMLElement) {\n                const icon = answerControl.querySelector('.fa');\n                if (icon instanceof HTMLElement) {\n                    icon.classList.replace('fa-square-o', 'fa-check-square-o');\n                }\n            }\n            this.isShowingCorrectAnswer = true;\n        });\n    }\n\n    /**\n     * Enables all buttons passed in arguments, but disables all others.\n     * @param {Array.<string>} buttons The unique part of the IDs of the buttons to be enabled.\n     */\n    static enableControls(buttons) {\n        document.querySelectorAll(selectors.quiz.controlButton).forEach(controlButton => {\n            controlButton.disabled = (buttons.indexOf(controlButton.dataset.control) === -1);\n        });\n    }\n\n    /**\n     * Enter fullscreen mode for better use with projectors.\n     */\n    static showFullscreenView() {\n        if (document.querySelector(selectors.main).classList.contains('jazzquiz-fullscreen')) {\n            Instructor.closeFullscreenView();\n            return;\n        }\n        // Hide the scrollbar - remember to always set back to auto when closing.\n        document.documentElement.style.overflowY = 'hidden';\n        // Sets the quiz view to an absolute position that covers the viewport.\n        document.querySelector(selectors.main).classList.add('jazzquiz-fullscreen');\n    }\n\n    /**\n     * Exit the fullscreen mode.\n     */\n    static closeFullscreenView() {\n        document.documentElement.style.overflowY = 'auto';\n        document.querySelector(selectors.main).classList.remove('jazzquiz-fullscreen');\n    }\n\n    /**\n     * Close the dropdown menu for choosing a question.\n     * @param {Event} event\n     * @param {string} name\n     */\n    static closeQuestionListMenu(event, name) {\n        // Close the menu if the click was not inside.\n        if (!event.target.closest(`#jazzquiz_${name}_menu`)) {\n            const menu = document.querySelector(`#jazzquiz_${name}_menu`);\n            menu.innerHTML = '';\n            menu.classList.remove('active');\n            const controlButton = document.querySelector(`#jazzquiz_control_${name}`);\n            if (controlButton) {\n                controlButton.classList.remove('active');\n            }\n        }\n    }\n\n    static addReportEventHandlers() {\n        document.addEventListener('click', event => {\n            const reportOverviewControlsButton = event.target.closest('#report_overview_controls button');\n            if (reportOverviewControlsButton) {\n                const action = reportOverviewControlsButton.dataset.action;\n                if (action === 'attendance') {\n                    document.querySelector(selectors.quiz.reportOverviewResponded).classList.remove('hidden');\n                    document.querySelector(selectors.quiz.reportOverviewResponses).classList.add('hidden');\n                } else if (action === 'responses') {\n                    document.querySelector(selectors.quiz.reportOverviewResponses).classList.remove('hidden');\n                    document.querySelector(selectors.quiz.reportOverviewResponded).classList.add('hidden');\n                }\n            }\n        });\n    }\n\n}\n\nexport const initialize = (totalQuestions, reportView, slots) => {\n    const quiz = new Quiz(Instructor);\n    quiz.role.totalQuestions = totalQuestions;\n    if (reportView) {\n        Instructor.addReportEventHandlers();\n        quiz.role.responses.showResponses = true;\n        slots.forEach(slot => {\n            const wrapper = 'jazzquiz_wrapper_responses_' + slot.num;\n            const table = 'responses_wrapper_table_' + slot.num;\n            const graph = 'report_' + slot.num;\n            quiz.role.responses.set(wrapper, table, slot.responses, undefined, slot.type, graph, false);\n        });\n    } else {\n        quiz.poll(500);\n    }\n};\n"],"names":["ResponseView","constructor","quiz","currentResponses","showVotesUponReview","respondedCount","showResponses","totalStudents","document","addEventListener","event","target","closest","selectors","undoMergeButton","undoMerge","showNormalResultsButton","refresh","showVoteResultsButton","refreshVotes","classList","contains","startMerge","id","parentNode","clear","querySelector","responses","innerHTML","responseInfo","hide","responsesControl","getElementById","HTMLElement","icon","replace","add","show","remove","this","toggle","endMerge","querySelectorAll","mergeInto","forEach","element","mergeFrom","post","merge","from","into","fromRowBarId","barCell","row","parentElement","fromRow","dataset","response","tableRow","cell","createControls","name","quizResponseInfo","question","hasVotes","state","showNormalResult","showVoteResult","html","children","addBarGraphRow","i","highestResponseCount","percent","parseInt","count","rowIndex","currentRowIndex","j","rows","length","insertRow","responseIndex","countHtml","responseCell","insertCell","onclick","latexId","qtype","currentRow","containsOutside","countElement","barElement","firstElementChild","style","width","createBarGraph","targetId","graphId","rebuild","prune","deleteRow","isSorting","insertBefore","set","wrapperId","tableId","responded","questionType","undefined","quizResponded","a","b","trim","exists","push","wrapper","sortBarGraph","get","data","has_votes","total_students","question_type","merge_count","quizResponses","answers","hasOwnProperty","attempt","finalcount","slot","Instructor","isShowingCorrectAnswer","totalQuestions","allowVote","key","closeFullscreenView","addEvents","repollQuestion","runVoting","showQuestionListSetup","nextQuestion","randomQuestion","endQuestion","showFullscreenView","showCorrectAnswer","closeSession","startQuiz","addHotkeys","closeQuestionListMenu","startQuizButton","exitQuizButton","keys","action","repeat","ctrlKey","toLowerCase","focusedElement","focusedTag","tagName","preventDefault","control","disabled","click","events","controlButton","enableControls","side","sideContainer","onNotRunning","student_count","info","controlButtons","studentsJoined","studentsJoinedCounter","onPreparing","enabledButtons","onRunning","questionTime","questiontime","isRunning","delay","startCountdown","onReviewing","Question","isLoaded","isNewState","onSessionClosed","correctAnswer","correctAnswerContainer","onVoting","onStateChange","startQuizControl","onQuestionRefreshed","voteable","onTimerEnding","onTimerTick","timeLeft","timer","controls","hideTimer","menu","margin","getBoundingClientRect","left","marginLeft","questions","questionButton","createElement","time","questionId","questionid","jazzquizQuestionId","jazzquizquestionid","jazzQuestionId","jumpQuestion","appendChild","selectedVoteOption","map","option","text","options","getSelectedAnswersForVote","encodeURIComponent","JSON","stringify","startQuestion","method","hideCorrectAnswer","box","controlsBox","window","location","href","split","answerControl","right_answer","buttons","indexOf","main","documentElement","overflowY","reportOverviewControlsButton","reportOverviewResponded","reportOverviewResponses","reportView","slots","Quiz","role","addReportEventHandlers","num","table","graph","type","poll"],"mappings":"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"}